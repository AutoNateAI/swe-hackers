<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Endless Opportunities Analytics | AutoNateAI</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Styles -->
    <link rel="stylesheet" href="../../shared/css/dashboard.css" />

    <style>
      .admin-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
      }

      .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .admin-title {
        font-family: var(--font-display);
        font-size: 1.75rem;
        font-weight: 700;
      }

      .admin-subtitle {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
      }

      .admin-badge {
        background: linear-gradient(135deg, #f44336, #e91e63);
        padding: 0.5rem 1rem;
        border-radius: var(--radius-full);
        font-size: 0.8rem;
        font-weight: 600;
      }

      .back-link {
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.9rem;
        transition: color 0.2s;
      }

      .back-link:hover {
        color: var(--text-primary);
      }

      /* Stats Row */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 1.25rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: 1.25rem 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .stat-card .stat-icon {
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
      }

      .stat-card .stat-value {
        font-family: var(--font-display);
        font-size: 1.75rem;
        font-weight: 700;
        line-height: 1.2;
      }

      .stat-card .stat-label {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
      }

      /* Chart Grid */
      .charts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .glass-card {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .glass-card__title {
        font-family: var(--font-display);
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--text-primary);
      }

      .chart-container {
        min-height: 250px;
        overflow: hidden;
      }

      .chart-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 250px;
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      /* Full-width sections below the grid */
      .section-full {
        margin-bottom: 1.5rem;
      }

      /* Data Table */
      .data-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        overflow: hidden;
      }

      .data-table th,
      .data-table td {
        padding: 0.85rem 1rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      .data-table th {
        background: var(--bg-tertiary);
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
      }

      .data-table tr:hover td {
        background: rgba(255, 255, 255, 0.02);
      }

      .sortable {
        cursor: pointer;
        user-select: none;
        transition: color 0.2s;
      }

      .sortable:hover {
        color: var(--accent-primary);
      }

      /* Loading & Access Denied */
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--bg-primary);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        z-index: 2000;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top-color: var(--accent-primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      .loading-text {
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .access-denied {
        text-align: center;
        padding: 4rem 2rem;
      }

      .access-denied h2 {
        font-family: var(--font-display);
        font-size: 2rem;
        margin-bottom: 1rem;
      }

      .access-denied p {
        color: var(--text-secondary);
        margin-bottom: 2rem;
      }

      .btn {
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background: var(--accent-primary);
        border: none;
        color: white;
      }

      .btn-primary:hover {
        background: var(--accent-secondary);
      }

      /* Data loading state */
      .data-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        padding: 3rem;
      }

      .data-loading .loading-spinner {
        width: 32px;
        height: 32px;
      }

      /* Responsive */
      @media (max-width: 1100px) {
        .stats-grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      @media (max-width: 900px) {
        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }

        .charts-grid {
          grid-template-columns: 1fr;
        }

        .data-table {
          display: block;
          overflow-x: auto;
        }
      }

      @media (max-width: 600px) {
        .admin-container {
          padding: 1rem;
        }

        .admin-header {
          flex-direction: column;
          gap: 1rem;
          align-items: flex-start;
        }
      }
    </style>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  </head>
  <body>
    <!-- Loading -->
    <div class="loading-overlay" id="loading">
      <div class="loading-spinner"></div>
      <div class="loading-text">Authenticating...</div>
    </div>

    <!-- Access Denied -->
    <div class="access-denied" id="access-denied" style="display: none">
      <h2>Access Denied</h2>
      <p>You don't have permission to view analytics.</p>
      <a href="../../dashboard/index.html" class="btn btn-primary">Go to Dashboard</a>
    </div>

    <!-- Main Content -->
    <div class="admin-container" id="admin-content" style="display: none">
      <header class="admin-header">
        <div>
          <h1 class="admin-title">Endless Opportunities Analytics</h1>
          <p class="admin-subtitle">AI Problem Solving Academy &mdash; Class performance overview</p>
        </div>
        <div style="display: flex; align-items: center; gap: 1rem;">
          <span class="admin-badge">Admin</span>
          <a href="../index.html" class="back-link">&larr; Admin Dashboard</a>
        </div>
      </header>

      <!-- Summary Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üë•</div>
          <div class="stat-value" id="stat-total-students">-</div>
          <div class="stat-label">Total Students</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚ö°</div>
          <div class="stat-value" id="stat-active-students">-</div>
          <div class="stat-label">Active Students</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üéØ</div>
          <div class="stat-value" id="stat-avg-accuracy">-</div>
          <div class="stat-label">Avg Accuracy</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìù</div>
          <div class="stat-value" id="stat-total-attempts">-</div>
          <div class="stat-label">Total Attempts</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚è±Ô∏è</div>
          <div class="stat-value" id="stat-avg-time">-</div>
          <div class="stat-label">Avg Time / Activity</div>
        </div>
      </div>

      <!-- Charts Grid -->
      <div class="charts-grid">
        <!-- Row 1: Two bar charts -->
        <div class="glass-card">
          <h4 class="glass-card__title">Class Accuracy by Lesson</h4>
          <div id="chart-accuracy-by-lesson" class="chart-container chart-loading">Loading chart...</div>
        </div>

        <div class="glass-card">
          <h4 class="glass-card__title">Student Participation by Lesson</h4>
          <div id="chart-completion-by-lesson" class="chart-container chart-loading">Loading chart...</div>
        </div>

        <!-- Row 2: Histogram + Donut -->
        <div class="glass-card">
          <h4 class="glass-card__title">Accuracy Distribution</h4>
          <div id="chart-accuracy-distribution" class="chart-container chart-loading">Loading chart...</div>
        </div>

        <div class="glass-card">
          <h4 class="glass-card__title">Activity Type Breakdown</h4>
          <div id="chart-activity-types" class="chart-container chart-loading">Loading chart...</div>
        </div>

      </div>

      <!-- Full-width sections (outside grid) -->
      <div class="section-full">
        <div class="glass-card">
          <h4 class="glass-card__title">Activity Over Time</h4>
          <div id="chart-activity-timeline" class="chart-container chart-loading">Loading chart...</div>
        </div>
      </div>

      <div class="section-full">
        <div class="glass-card">
          <h4 class="glass-card__title">Student Engagement</h4>
          <div id="student-table-container" class="chart-loading" style="min-height: 200px;">Loading student data...</div>
        </div>
      </div>

      <div class="section-full">
        <div class="glass-card">
          <h4 class="glass-card__title">Top Struggling Activities</h4>
          <div id="struggling-activities-container" class="chart-loading" style="min-height: 200px;">Loading activities...</div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="../../shared/js/firebase-config.js"></script>
    <script src="../../shared/js/auth.js"></script>
    <script src="../../shared/js/rbac.js"></script>
    <script src="eo-analytics.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        // 1. Init Firebase
        if (!window.FirebaseApp.init()) {
          console.error('Firebase initialization failed');
          document.getElementById('loading').innerHTML = '<p style="color: var(--text-muted);">Firebase initialization failed.</p>';
          return;
        }

        window.AuthService.init();

        // 2. Wait for auth
        const user = await window.AuthService.waitForAuthState();
        if (!user) {
          window.location.href = '../../auth/login.html';
          return;
        }

        // 3. Check admin role
        if (window.RBACService) {
          const isAdmin = await window.RBACService.hasRole('admin');
          if (!isAdmin) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('access-denied').style.display = 'block';
            return;
          }
        }

        // 4. Show content, update loading message
        document.getElementById('loading').style.display = 'none';
        document.getElementById('admin-content').style.display = 'block';

        // 5. Fetch data and render charts
        try {
          const data = await window.EOAnalytics.fetchAllData();
          window.EOAnalytics.renderAll(data);
        } catch (error) {
          console.error('Error loading analytics:', error);
          document.querySelectorAll('.chart-loading').forEach(el => {
            el.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">Error loading data. Check console for details.</div>';
          });
        }
      });
    </script>
  </body>
</html>
